name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
      - "feature/**"
      - "fix/**"
      - "bugfix/**"
      - "release/**"
      - "hotfix/**"
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      aws_region:
        description: "AWS region override (optional)"
        required: false
        default: "ap-south-1"

env:
  AWS_REGION: ${{ inputs.aws_region || vars.AWS_REGION || 'ap-south-1' }}
  PYTHON_VERSION: "3.11"
  ECR_REPOSITORY: langchain-agent

jobs:
  build:
    name: Build & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black isort pytest pytest-cov
      - name: Lint with flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      - name: Check code formatting (black)
        run: black --check . || true
      - name: Check import sorting (isort)
        run: isort --check-only . || true
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-dependencies
          path: requirements.txt

  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      - name: Run unit tests with coverage
        run: |
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=html || true
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pytest-results
          path: htmlcov/

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install security tools
        run: pip install bandit safety
      - name: Run Bandit (security linting)
        run: bandit -r . -f json -o bandit-report.json || true
      - name: Check for vulnerable dependencies
        run: safety check --json || true
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: bandit-report.json

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      id-token: write
      contents: read
    outputs:
      image-uri: ${{ steps.build-image.outputs.image_uri }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: Ensure ECR repository exists
        env:
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
        run: |
          aws ecr describe-repositories --repository-names "$ECR_REPOSITORY" --region "$AWS_REGION" >/dev/null 2>&1 || \
          aws ecr create-repository --repository-name "$ECR_REPOSITORY" --region "$AWS_REGION"
      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE_URI="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          docker buildx build \
            -t "$IMAGE_URI" \
            -t "$ECR_REGISTRY/$ECR_REPOSITORY:latest" \
            --push \
            .
          echo "image_uri=$IMAGE_URI" >> "$GITHUB_OUTPUT"

  deploy:
    name: Deploy to AWS ECS
    runs-on: ubuntu-latest
    needs: [build-docker]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Validate required deployment secrets
        run: |
          test -n "${{ secrets.ECS_CLUSTER }}" || (echo "Missing secret: ECS_CLUSTER" && exit 1)
          test -n "${{ secrets.ECS_SERVICE }}" || (echo "Missing secret: ECS_SERVICE" && exit 1)
          test -n "${{ secrets.ECS_TASK_EXECUTION_ROLE_ARN }}" || (echo "Missing secret: ECS_TASK_EXECUTION_ROLE_ARN" && exit 1)
          test -n "${{ secrets.ECS_TASK_ROLE_ARN }}" || (echo "Missing secret: ECS_TASK_ROLE_ARN" && exit 1)
          test -n "${{ secrets.OPENAI_SECRET_ARN }}" || (echo "Missing secret: OPENAI_SECRET_ARN" && exit 1)
          test -n "${{ secrets.PERPLEXITY_SECRET_ARN }}" || (echo "Missing secret: PERPLEXITY_SECRET_ARN" && exit 1)
      - name: Ensure CloudWatch log group exists
        run: |
          aws logs create-log-group --log-group-name "/ecs/langchain-agent" --region "$AWS_REGION" || true
      - name: Render ECS task definition
        env:
          IMAGE_URI: ${{ needs.build-docker.outputs.image-uri }}
          ECS_TASK_EXECUTION_ROLE_ARN: ${{ secrets.ECS_TASK_EXECUTION_ROLE_ARN }}
          ECS_TASK_ROLE_ARN: ${{ secrets.ECS_TASK_ROLE_ARN }}
          OPENAI_SECRET_ARN: ${{ secrets.OPENAI_SECRET_ARN }}
          PERPLEXITY_SECRET_ARN: ${{ secrets.PERPLEXITY_SECRET_ARN }}
          LLM_PROVIDER: ${{ vars.LLM_PROVIDER || 'openai' }}
        run: |
          jq \
            --arg image "$IMAGE_URI" \
            --arg region "$AWS_REGION" \
            --arg executionRoleArn "$ECS_TASK_EXECUTION_ROLE_ARN" \
            --arg taskRoleArn "$ECS_TASK_ROLE_ARN" \
            --arg openaiSecretArn "$OPENAI_SECRET_ARN" \
            --arg perplexitySecretArn "$PERPLEXITY_SECRET_ARN" \
            --arg llmProvider "$LLM_PROVIDER" \
            '
            .family = "langchain-agent" |
            .containerDefinitions[0].name = "langchain-agent" |
            .containerDefinitions[0].image = $image |
            .containerDefinitions[0].logConfiguration.options["awslogs-region"] = $region |
            .containerDefinitions[0].environment = [{"name":"LLM_PROVIDER","value":$llmProvider}] |
            .containerDefinitions[0].secrets = [
              {"name":"OPENAI_API_KEY","valueFrom":$openaiSecretArn},
              {"name":"PERPLEXITY_API_KEY","valueFrom":$perplexitySecretArn}
            ] |
            .executionRoleArn = $executionRoleArn |
            .taskRoleArn = $taskRoleArn
            ' deployment/ecs-task-definition.json > ecs-task-definition.rendered.json
      - name: Deploy task definition to ECS service
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ecs-task-definition.rendered.json
          cluster: ${{ secrets.ECS_CLUSTER }}
          service: ${{ secrets.ECS_SERVICE }}
          wait-for-service-stability: true
      - name: Send deployment notification
        run: |
          echo "Deployment complete for commit ${{ github.sha }}"
          echo "Region: $AWS_REGION"
          echo "Image: ${{ needs.build-docker.outputs.image-uri }}"

  integration-test:
    name: Integration Tests on AWS
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest requests
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Run integration tests
        env:
          LLM_PROVIDER: perplexity
        run: pytest tests/integration/ -v --tb=short || true
      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: test-results/
